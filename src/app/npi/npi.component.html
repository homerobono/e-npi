<div class='container'>
  <div class='row justify-content-center'>
    <div class='col body-main'>
      <app-nav-buttons></app-nav-buttons>
      <div class='row pb-0'>
        <div class='col'>
          <div class='row pb-0 align-items-end'>
            <div class='col-xs col-md-auto mb-0 mr-0 pr-0'>
              <h3 class='mb-0' [ngClass]='{strike: npi.stage == 0}'>
                NPI #{{ npi.number }} -
                <span id='titleLabel' *ngIf='!titleEdit' #name [ngClass]='
                  {"text-primary": titleField != npi.name && 
                    route.snapshot.routeConfig.path.includes("/edit")
                  }'>
                  {{ 
                    this.route.snapshot.routeConfig.path.includes("/edit") ? titleField : npi.name
                  }}
                  <small class='text-secondary'>{{ npi.version > 1 ? ' (v' + npi.version + ')' : '' }}</small>
                </span>
              </h3>
            </div>
            <div class="col input-group input-group-lg" [style.display]='titleEdit?"flex":"none"'>
              <input type=text class='form-control' (keyup)="changeTitle($event)" (clickOutside)="toggleTitleEdit($event)" name='titleInput'
                autofocus id='titleInput' [(ngModel)]='titleField'>
            </div>
            <div class='col-auto'>
              <span class='fa fa-circle' [ngClass]='{
                "text-danger" : npi.stage == 0,
                "text-secondary" : npi.stage == 1,
                "text-warning" : npi.stage == 2,
                "text-success" : npi.stage == 3,
                "text-info" : npi.stage == 4
                }'></span>
              <i class='text-secondary'> {{ utils.getStatus(npi.stage) }} </i>
            </div>
          </div>
          <div class='row align-items-end'>
            <small class='col-auto mb-0 mt-0 pr-0'>
              <a routerLink='/users/{{ authorId }}'>
                {{ authorName }}</a>, {{ npi.createdString }}
            </small>
            <div class='col-auto align-self-center'>
              <span class='badge mt-1' [ngClass]='{
                "badge-success" : npi.entry=="pixel",
                "badge-purple" : npi.entry=="oem",
                "badge-secondary" : npi.entry=="internal",
                "badge-info" : npi.entry=="custom"
                }'>
                {{ utils.getEntry(npi.entry) }}
              </span>
            </div>
          </div>
        </div>
        <div class='col-auto pl-md-0 ml-0'>
          <div class='btn-group'>
            <button (click)='cancelNpi()' class='btn btn-danger' *ngIf='npi.stage == 2 || npi.stage == 3'
              data-toggle="tooltip" data-placement="top" title="Cancelar NPI">
              <i class='fa fa-times fa-fw'></i>
            </button>
            <button (click)='cancelNpi()' class='btn btn-danger' *ngIf='npi.stage < 2'
            data-toggle="tooltip" data-placement="top" title="Remover NPI">
              <i class='fa fa-trash fa-fw'></i>
            </button>
            <button routerLink='edit' class='btn btn-info' *ngIf='!route.snapshot.routeConfig.path.includes("/edit") && npi.stage < 4'
            data-toggle="tooltip" data-placement="top" title="Editar NPI">
              <i class='fa fa-pencil fa-fw'></i>
            </button>
            <button routerLink='/npi/{{ npi.number }}/' class='btn btn-secondary' *ngIf='route.snapshot.routeConfig.path.includes("/edit")'
            data-toggle="tooltip" data-placement="top" title="Visualizar NPI">
              <i class='fa fa-eye fa-fw'></i>
            </button>
            <button (click)='submitToAnalisys(npiForm.value)' class='btn btn-warning text-white' *ngIf='route.snapshot.routeConfig.path.includes("/edit") && npi.stage == 1'
            data-toggle="tooltip" data-placement="top" title="Submeter NPI para Análise Crítica">
              <i class='fa fa-check-circle-o fa-fw'></i>
            </button>
            <button (click)='submitNpi(npiForm.value)' class='btn btn-success' *ngIf='route.snapshot.routeConfig.path.includes("/edit") && npi.stage < 4'
            data-toggle="tooltip" data-placement="top" title="Salvar alterações">
              <i class='fa fa-save fa-fw'></i>
            </button>
            <button (click)='finalizeNpi()' class='btn btn-primary text-white' 
            *ngIf='route.snapshot.routeConfig.path.includes("/edit") && npi.stage == 3 && 
            (npiForm.get("validation")!=null && npiForm.get("validation").valid)'
            data-toggle="tooltip" data-placement="top" title="Finalizar NPI">
              <i class='fa fa-check fa-fw'></i>
            </button>
          </div>
          <button type="toggleEdit()" class="btn btn-outline-info shadow-none" [disabled]="sendingForm" *ngIf='npi.stage == 4'>
            Alterar Campos...
          </button>
          <div class='row'>
            <div class='col-6'>
              <select class="custom-select" id="motivation" #motivation>
                <option disabled selected value>Selecione um motivo...</option>
                <option *ngFor="let mot of motivations" value='{{ mot.value }}'>
                  {{ mot.label }}
                </option>
              </select>
              </div>
              <div class='col-6'>
              <select class="custom-select" id="field" *ngIf='motivation.value!=""'>
                  <option disabled selected value>Selecione o campo afetado...</option>
                  <option *ngFor="let mot of motivations" value='{{ mot.value }}'>
                    {{ mot.label }}
                  </option>
                </select>
              <div class='invalid-feedback'>
                Defina o motivo
              </div>
            </div>
          </div>
        </div>
      </div>
      <form [formGroup]='npiForm' (ngSubmit)="submitNpi(npiForm.value)">
        <hr>
        <app-oem [npi]='npi' (npiFormOutput)='setChild($event)' *ngIf='npi.entry=="oem"'></app-oem>
        <app-pixel [npi]='npi' (npiFormOutput)='setChild($event)' *ngIf='npi.entry=="pixel"'></app-pixel>
        <app-internal [npi]='npi' (npiFormOutput)='setChild($event)' *ngIf='npi.entry=="internal"'></app-internal>
        <app-custom [npi]='npi' (npiFormOutput)='setChild($event)' *ngIf='npi.entry=="custom"'></app-custom>

        <app-critical [npi]='npi' (criticalForm)='setChild($event)' *ngIf='npi.stage > 1'></app-critical>

        <app-client [npi]='npi' (npiFormOutput)='setChild($event)' 
        *ngIf='npi.entry=="oem" && npi.stage > 1 && npi.isCriticallyApproved()'></app-client>

        <app-activities [npi]='npi' (npiFormOutput)='setChild($event)' *ngIf='npi.stage > 2 && npi.isCriticallyApproved()'></app-activities>
        
        <app-validate [npi]='npi' (npiFormOutput)='setChild($event)' *ngIf='npi.stage > 2 && npi.isCriticallyApproved()'></app-validate>

        <div class="row align-items-center justify-content-between" *ngIf='!route.snapshot.data["readOnly"]'>
          <div class='col-auto text-secondary'>
            <div class='text-secondary reset' (click)='reset()' data-toggle="tooltip" data-placement="top" title="Desfazer alterações"
              [ngClass]='{"reset-disabled":npi===npiForm.value}'>
              <i class="fa fa-undo fa-2x"></i>
            </div>
          </div>
        </div>
        <div class="row align-items-center justify-content-between" *ngIf='!route.snapshot.data["readOnly"]'>
          <div class='col pr-0'>
            <button type="button" class="btn btn-danger" [disabled]="sendingForm" (click)='cancelNpi()' *ngIf='npi.stage == 2 || npi.stage == 3'>
              <span class='fa fa-times-circle'></span>
                Cancelar NPI
            </button>
            <button type="button" class="btn btn-outline-danger shadow-none" [disabled]="sendingForm" (click)='cancelNpi()' *ngIf='npi.stage == 0 || npi.stage == 1'>
              <span class='fa fa-trash'></span>
                Remover NPI
            </button>
          </div>
          <div class='col text-center' *ngIf='npi.stage == 1'>
            <button type="button" class="btn btn-default btn-orange" [disabled]="sendingForm" (click)='submitToAnalisys(npiForm.value)'>
              Análise Crítica
            </button>
          </div>
          <div class='col text-right pl-0'>
            <button type="submit" class="btn btn-success" [disabled]="sendingForm" *ngIf='npi.stage < 4 && !newFormVersionFlag'>
              <i class='fa fa-save fa-fw'></i>
              Salvar
            </button>
            <button type="submit" class="btn btn-outline-success" [disabled]="sendingForm" *ngIf='npi.stage < 4 && newFormVersionFlag'>
                <i class='fa fa-save fa-fw'></i>
                Salvar Nova Versão
              </button>
            <button type="toggleEdit()" class="btn btn-outline-info shadow-none" [disabled]="sendingForm" *ngIf='npi.stage == 4'>
              Alterar Campos...
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>